# 精度修正說明

## 已完成的修正

### 1. ✅ 時間轉換：引入 pytz 庫

**改進：**
- 添加了 `pytz` 庫到 `requirements.txt`
- 創建了 `datetime_to_jd_utc()` 函數，支持時區字符串參數
- 可以使用 `'Asia/Taipei'`, `'America/New_York'` 等標準時區名稱
- 如果時區轉換失敗，會自動回退到經度估算方法

**使用方式：**
```python
# 使用時區字符串（推薦）
jd = datetime_to_jd_utc(datetime.datetime(1990, 5, 15, 14, 30), 'Asia/Taipei')

# 或使用經度估算（當 timezone_str 為 None 時）
jd = datetime_to_jd_utc(datetime.datetime(1990, 5, 15, 14, 30), None, longitude=121.5)
```

**API 支持：**
- 現在 API 接受可選的 `timezone` 參數
- 如果提供，會使用精確的時區轉換
- 如果不提供，會使用經度估算

### 2. ✅ 設計時間計算：精確迭代方法

**改進：**
- 已實現迭代方法，精確尋找太陽度數少 88.0 度的 UTC 時間點
- 使用牛頓法迭代，精度達到 0.00001 度（約 0.036 角秒）
- 計算太陽的實際日運動速度，而不是假設固定速度
- 使用前後各 0.01 天的位置來估算速度，提高精度

**算法：**
1. 獲取出生時刻的太陽位置
2. 計算目標太陽位置（出生太陽位置 - 88 度）
3. 初始估計：約 89.3 天前（基於平均日運動速度）
4. 迭代計算：
   - 計算當前時刻太陽位置
   - 計算與目標位置的差異
   - 計算太陽的實際日運動速度
   - 根據差異和速度調整日期
   - 重複直到差異小於容差（0.00001 度）

### 3. ✅ 閘門偏移校正：41 閘門起始於 302°

**重要修正：**
- **舊的錯誤：** 假設 0 度對應 41 閘門
- **正確的標準：** 41 閘門起始於水瓶座 2°00'00"，即黃道經度 302°00'00"

**實現：**
```python
GATE_41_START_DEGREE = 302.0  # 41閘門起始黃道經度（水瓶座 2°）
```

**轉換算法：**
1. 計算從 302° 開始的偏移量
2. 如果經度 < 302°，需要加上 360° 來正確計算（因為是循環的）
3. 閘門 = 41 + (偏移量 / 5.625°)
4. 如果閘門 > 64，循環回到 1

**驗證：**
- 302.0° → 41.1 ✅
- 307.625° (302° + 5.625°) → 42.1 ✅
- 296.375° (302° - 5.625°) → 40.1 ✅

### 4. ✅ 爻線計算：精度確認

**確認：**
- 每條爻線寬度 = 0.9375° ✅（5.625° / 6 = 0.9375°）
- 返回格式為「閘門.爻線」（例如：`"15.2"`）✅

**計算方法：**
```python
gate_position = adjusted_longitude % GATE_DEGREE  # 閘門內的度數
line = int(gate_position / LINE_DEGREE) + 1       # 爻線編號（1-6）
```

**驗證：**
- 302.0° → 41.1 ✅
- 302.9375° (302° + 0.9375°) → 41.2 ✅
- 303.875° (302° + 2×0.9375°) → 41.3 ✅

## 測試

運行測試腳本驗證所有修正：

```bash
python test_precision_corrections.py
```

測試包括：
1. 閘門偏移測試（驗證 41 閘門起始於 302°）
2. 爻線計算精度測試
3. 時區轉換測試
4. 設計時間計算測試（驗證 88 度太陽弧）

## API 使用示例

### 使用時區字符串（推薦）

```json
{
  "year": 1990,
  "month": 5,
  "day": 15,
  "time": "14:30",
  "timezone": "Asia/Taipei",
  "longitude": 121.5,
  "latitude": 25.0
}
```

### 使用經度估算（向後兼容）

```json
{
  "year": 1990,
  "month": 5,
  "day": 15,
  "time": "14:30",
  "longitude": 121.5,
  "latitude": 25.0
}
```

## 安裝依賴

確保安裝了所有必需的庫：

```bash
pip install -r requirements.txt
```

這會安裝：
- Flask
- flask-cors
- pytz
- pyswisseph（如果尚未安裝）

## 注意事項

1. **時區轉換：** 如果提供了 `timezone` 參數，系統會使用 `pytz` 進行精確轉換。如果不提供，會使用經度估算（每15度 = 1小時）。

2. **閘門計算：** 所有閘門計算現在都基於正確的 302° 起始點，這與專業人類圖工具一致。

3. **設計時間：** 不再使用簡單的「減去 88 天」，而是精確計算太陽位置，確保準確性。

4. **精度：** 所有計算都達到高精度（設計時間計算精度為 0.00001 度）。













