# 潛意識月亮數據修正說明

## 已完成的關鍵修正

### 1. ✅ 時區預處理（強制 UTC 轉換）

**實現位置：** `datetime_to_jd_utc()` 函數

**修正內容：**
- 強制使用 `pytz` 庫進行精確的時區轉換
- 優先使用 `timezone_str` 參數（例如 'Asia/Shanghai'）進行轉換
- 正確處理夏令時（DST）等複雜的時區規則
- 若未提供時區字符串，使用經度估算（但精度較低）

**關鍵代碼：**
```python
if timezone_str:
    local_tz = pytz.timezone(timezone_str)
    local_time_aware = local_tz.localize(date_time)
    utc_time = local_time_aware.astimezone(pytz.UTC)
```

**重要性：**
- 若時間未正確轉為 UTC，月亮位置會產生約 4 度的誤差
- 這是因為月亮運動速度快（每天約 13 度），時區差異會直接影響計算結果

---

### 2. ✅ 精確太陽弧搜尋（迭代法）

**實現位置：** `calculate_design_date()` 函數

**修正內容：**
- **絕對不使用**簡單的「減去 88 天」方法
- 使用迭代法（牛頓-拉夫遜法）精確搜尋太陽黃道度數剛好比出生時少 **88.0000 度**的確切時刻
- 迭代精度：0.00001 度（約 0.036 角秒，對應約 0.0001 天，即約 8.6 秒）
- 使用前後各 0.001 天的位置來精確計算太陽的日運動速度

**計算邏輯：**
1. 計算出生時刻的太陽黃道經度（使用精密星曆檔案）
2. 目標太陽位置 = 出生太陽位置 - **精確 88.0000 度**
3. 使用迭代法精確搜尋太陽剛好在目標位置的時刻（JD）
4. 確保設計日期是「往回」移動 88.0 度，而不是「往前」移動 272 度

**關鍵代碼：**
```python
design_sun_long = birth_sun_long - DESIGN_SUN_ARC  # 精確減去 88.0 度
# ... 迭代搜尋 ...
for iteration in range(max_iterations):
    current_sun_long = swe.calc_ut(design_jd, swe.SUN, calc_flag)[0]
    diff = current_sun_long - design_sun_long
    # ... 調整 design_jd 直到 abs(diff) < tolerance ...
```

**重要性：**
- 這是人類圖系統的核心計算：設計層（Design）對應出生前 **精確 88.0 度**太陽弧的時刻
- 太陽運動速度並非恆定，簡單的減法會導致誤差

---

### 3. ✅ 啟用高精度模式

**實現位置：** 程式啟動時（頂部）和所有計算函數

**修正內容：**

#### 3.1 設置星曆檔案路徑
```python
ephe_path = './ephe'
swe.set_ephe_path(ephe_path)
```

#### 3.2 強制使用精密星曆檔案標誌
所有 `swe.calc_ut()` 調用都使用 `swe.FLG_SWIEPH` 標誌：

- `calculate_design_date()`: 使用 `calc_flag = swe.FLG_SWIEPH`
- `get_planet_position()`: 使用 `calc_flag = swe.FLG_SWIEPH`
- 所有行星位置計算都確保使用精密星曆檔案

**關鍵代碼：**
```python
calc_flag = swe.FLG_SWIEPH
sun_pos, _ = swe.calc_ut(jd, swe.SUN, calc_flag)
```

**重要性：**
- `swe.FLG_SWIEPH` 確保使用下載的 `.se1` 數據檔（如 `seas_18.se1`, `sem_18.se1`）
- 如果不使用此標誌，系統會降級使用 Moshier 簡化模型（精度較低）
- 對於月亮位置的精確計算，必須使用精密星曆檔案

---

### 4. ✅ 驗證數據

**測試案例：** 2002-09-21 01:31 (UTC+8)

**預期結果：**
- 潛意識月亮應對齊到 **44.4**（閘門 44，第 4 條爻線）
- 人生角色應自動判斷為 **6/2**

**測試腳本：** `test_moon_44_4.py`

運行測試：
```bash
cd 人類圖
python test_moon_44_4.py
```

---

## 完整計算流程

1. **用戶輸入**：出生日期時間（本地時間） + 時區字符串 + 經緯度
2. **時區轉換**：使用 `pytz` 將本地時間轉換為 UTC 時間
3. **計算出生 JD**：將 UTC 時間轉換為儒略日（JD）
4. **計算設計日期**：使用迭代法搜尋太陽往回移動 88.0 度的確切時刻（JD）
5. **計算行星位置**：
   - Personality（意識層）：使用出生 JD 計算所有行星位置
   - Design（潛意識層）：使用設計 JD 計算所有行星位置
6. **轉換為閘門.爻線**：將黃道經度轉換為人類圖格式（例如 44.4）

---

## 技術細節

### 使用的庫和標誌

- **pytz**: 時區轉換（處理夏令時等複雜情況）
- **pyswisseph**: 天文計算
- **swe.FLG_SWIEPH**: 強制使用精密星曆檔案標誌
- **swe.set_ephe_path('./ephe')**: 設置星曆檔案路徑

### 精度保證

- **迭代精度**：0.00001 度（約 0.036 角秒）
- **時間精度**：約 0.0001 天（約 8.6 秒）
- **月亮位置精度**：正確的 UTC 轉換 + 精密星曆檔案 = 極高精度

---

## 注意事項

1. **必須提供時區字符串**：為了獲得最高精度，建議始終提供 `timezone_str` 參數（例如 'Asia/Shanghai'）
2. **星曆檔案必須存在**：確保 `./ephe` 資料夾中包含 `seas_18.se1` 和 `sem_18.se1` 檔案
3. **UTC 轉換的重要性**：若時間未正確轉為 UTC，月亮位置會產生約 4 度的誤差
4. **迭代法的重要性**：不能簡單使用「減去 88 天」，必須使用迭代法精確搜尋 88.0 度太陽弧

---

## 修正完成確認

✅ 時區預處理：使用 pytz 確保用戶輸入的時間先轉換為 UTC  
✅ 精確太陽弧搜尋：實作疊代法，尋找太陽黃道度數剛好比出生時少 88.0000 度  
✅ 啟用高精度模式：調用 `swe.set_ephe_path('./ephe')`  
✅ 強制使用精密星曆檔案：所有計算使用 `swe.FLG_SWIEPH` 標誌  
⏳ 驗證數據：需要運行測試腳本確認結果

---

**最後更新：** 2024年
**狀態：** 所有關鍵修正已完成，待測試驗證









