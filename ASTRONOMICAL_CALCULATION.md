# 真實天文計算功能說明

## 概述

已將模擬數據計算升級為使用 `pyswisseph` 庫的真實天文計算。現在系統能夠：

1. 計算真實的行星位置（基於 Swiss Ephemeris）
2. **精確計算設計日期**（精確搜尋太陽度數減去88度的時刻，而非簡單回推88天）
3. **正確的閘門轉換**（使用標準曼陀羅起始點：0度對應41閘門起始點）
4. **精確的時區轉換**（考慮出生地的經緯度轉換為UTC）

## 重要改進

### 1. 設計日期計算精度提升
- **舊方法：** 簡單回推約88天
- **新方法：** 精確搜尋太陽度數減去88度的確切時刻
- **精度：** 達到0.0001度（約0.36角秒）
- **算法：** 迭代搜索，考慮太陽運動速度的變化

### 2. 曼陀羅起始點修正
- **重要：** 人類圖系統中，0度黃道經度對應**41閘門起始點**，不是1閘門
- **偏移量：** 40（因為41-1=40）
- **影響：** 所有閘門計算都基於正確的曼陀羅起始點

### 3. 時區轉換改進
- 考慮出生地的經緯度
- 將本地時間精確轉換為UTC時間
- 確保天文計算的準確性

## 核心函數

### `get_planet_positions(year, month, day, hour, minute, longitude, latitude)`

**功能：** 計算兩組行星位置數據

**參數：**
- `year`: 出生年份（例如：1990）
- `month`: 出生月份（1-12）
- `day`: 出生日期（1-31）
- `hour`: 出生小時（0-23）
- `minute`: 出生分鐘（0-59）
- `longitude`: 出生地經度（東經為正，西經為負，例如：121.5 表示東經121.5度）
- `latitude`: 出生地緯度（北緯為正，南緯為負，例如：25.0 表示北緯25度）

**返回：**
- `(personality_list, design_list)` 元組
- 每個列表包含13個行星的信息字典

**每個行星信息包含：**
```python
{
    'planet': 'Sun',           # 行星名稱
    'gate': 15,                # 閘門數字（1-64）
    'line': 2,                 # 爻線數字（1-6）
    'gate_line': '15.2',       # 閘門.爻線格式
    'sign': '謙',              # 對應的卦名
    'longitude': 265.34        # 黃道經度（用於調試）
}
```

### `degrees_to_gate_line(longitude)`

**功能：** 將黃道經度轉換為閘門和爻線

**重要：** 使用標準曼陀羅起始點，0度對應41閘門起始點

**計算規則：**
- 360度 / 64閘門 = 5.625度 每個閘門
- 每個閘門有6條爻線，所以每條爻線 = 5.625 / 6 = 0.9375度
- **曼陀羅偏移：** 0度黃道經度對應41閘門起始點（偏移量 = 40）

**算法：**
```python
# 應用曼陀羅偏移
adjusted_longitude = (longitude + 40 * 5.625) % 360.0
閘門 = floor(adjusted_longitude / 5.625) + 1  # 範圍：1-64
爻線 = floor((adjusted_longitude % 5.625) / 0.9375) + 1  # 範圍：1-6
```

**示例：**
- 0度 → 41閘門.1爻線
- 5.625度 → 42閘門.1爻線
- 354.375度 → 40閘門.1爻線

### `calculate_design_date(birth_jd, birth_lat)`

**功能：** 計算設計日期（出生前88度太陽弧的日期）

**重要改進：** 精確搜尋太陽度數減去88度的時刻，而不是簡單回推88天

**算法：**
1. 獲取出生時刻的太陽位置
2. 計算目標太陽位置（出生太陽位置 - 88度）
3. 初始估計：太陽每天約移動0.9856度，所以88度約等於89.3天前
4. 使用迭代算法（最多50次迭代）精確搜索：
   - 計算當前時刻的太陽位置
   - 計算與目標位置的差異
   - 計算太陽的日運動速度（使用前後0.5天的位置）
   - 根據差異和速度調整日期
   - 精度要求：差異小於0.0001度（約0.36角秒）
5. 找到太陽在目標經度的確切時刻

**優勢：**
- 考慮太陽運動速度的變化（不是固定的每天1度）
- 達到極高精度（0.0001度）
- 自動處理360度循環

## 時區轉換

系統使用經緯度來進行時區轉換：
- 每15度經度約等於1小時時差
- 將本地時間轉換為UTC時間進行計算
- 考慮出生地的經緯度進行精確轉換

**實現：**
- `datetime_to_jd()` 函數接收經度和緯度參數
- 根據經度計算時區偏移（小時）
- 將本地時間減去時區偏移得到UTC時間
- 使用UTC時間計算儒略日

**注意：** 這是一個基於經度的簡化方法。對於更精確的計算（考慮夏令時、時區邊界等），建議使用時區數據庫（如 `pytz`）。但對於天文計算，基於經度的轉換已經足夠準確。

## 13個行星

系統計算以下13個行星/天體：

1. **Sun**（太陽）- 使用 `swe.SUN`
2. **Earth**（地球）- 太陽對面（+180度）
3. **Moon**（月亮）- 使用 `swe.MOON`
4. **North Node**（北交點）- 使用 `swe.TRUE_NODE`
5. **South Node**（南交點）- 北交點 + 180度
6. **Mercury**（水星）- 使用 `swe.MERCURY`
7. **Venus**（金星）- 使用 `swe.VENUS`
8. **Mars**（火星）- 使用 `swe.MARS`
9. **Jupiter**（木星）- 使用 `swe.JUPITER`
10. **Saturn**（土星）- 使用 `swe.SATURN`
11. **Uranus**（天王星）- 使用 `swe.URANUS`
12. **Neptune**（海王星）- 使用 `swe.NEPTUNE`
13. **Pluto**（冥王星）- 使用 `swe.PLUTO`

## API 使用

### 請求格式

```json
{
  "year": 1990,
  "month": 5,
  "day": 15,
  "time": "14:30",
  "longitude": 121.5,  // 可選，默認 0.0
  "latitude": 25.0     // 可選，默認 0.0
}
```

### 響應格式

```json
{
  "status": "success",
  "data": {
    "input_date": "1990-05-15 14:30",
    "type": "Generator（生產者）",
    "strategy": "Wait to Respond（等待回應）",
    "inner_authority": "...",
    "defined_centers_status": {...},
    "personality_list": [
      {
        "planet": "Sun",
        "gate": 15,
        "line": 2,
        "gate_line": "15.2",
        "sign": "謙"
      },
      ...
    ],
    "design_list": [
      {
        "planet": "Sun",
        "gate": 44,
        "line": 3,
        "gate_line": "44.3",
        "sign": "姤"
      },
      ...
    ]
  }
}
```

## 錯誤處理

如果天文計算失敗（例如：pyswisseph 未安裝或計算錯誤），系統會自動回退到模擬數據生成方法，確保系統仍然可以運行。

## 測試

運行測試腳本：

```bash
python test_ephemeris.py
```

這會測試：
- 天文計算功能
- 閘門轉換函數
- 經緯度處理

## 注意事項

1. **精度：** Swiss Ephemeris 提供非常高的精度（約0.0003角秒）
2. **範圍：** 支持從-6000年到+10000年的日期範圍
3. **性能：** 計算速度很快，通常在毫秒級別完成
4. **依賴：** 需要安裝 `pyswisseph` 庫（`pip install pyswisseph`）

## 參考資料

- [Swiss Ephemeris 官方文檔](https://www.astro.com/swisseph/)
- [pyswisseph GitHub](https://github.com/astrorigin/pyswisseph)


